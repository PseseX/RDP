name: Windows RDP (6h with ngrok)

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user runneradmin P@ssw0rd123!

      - name: Download & Setup ngrok
        shell: pwsh
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          $zip = "$env:TEMP\ngrok.zip"
          Invoke-WebRequest "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile $zip
          Expand-Archive $zip -DestinationPath "$env:USERPROFILE\ngrok" -Force
          $ngrok = "$env:USERPROFILE\ngrok\ngrok.exe"
          & $ngrok config add-authtoken $env:NGROK_AUTH_TOKEN

      - name: Start ngrok TCP 3389 and capture RDP address
        shell: pwsh
        run: |
          $ngrok = "$env:USERPROFILE\ngrok\ngrok.exe"
          $log   = "$env:TEMP\ngrok.log"
          Start-Process -FilePath $ngrok -ArgumentList "tcp 3389" -NoNewWindow -RedirectStandardOutput $log
          Start-Sleep -Seconds 10

          $tries=0;$addr=$null
          while($tries -lt 30 -and -not $addr){
            if(Test-Path $log){
              $text = Get-Content $log -Raw
              $m = [regex]::Match($text,"tcp://[a-z0-9\.\-]+:\d+")
              if($m.Success){ $addr=$m.Value }
            }
            if(-not $addr){ Start-Sleep -Seconds 2; $tries++ }
          }

          if(-not $addr){
            Write-Host "==== ngrok last log lines ===="
            if(Test-Path $log){ Get-Content $log -Tail 120 }
            throw "Could not find ngrok TCP address (check NGROK_AUTH_TOKEN / account)."
          }

          Write-Host "==================================="
          Write-Host "RDP Address: $addr"
          Write-Host "User: runneradmin"
          Write-Host "Pass: P@ssw0rd123!"
          Write-Host "==================================="

      - name: Keep alive ~6h
        shell: pwsh
        run: Start-Sleep -Seconds 21600


